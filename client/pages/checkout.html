<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - E-Shop</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="/pages/index.html" class="navbar-brand">E-Shop</a>
      <ul class="navbar-menu">
        <!-- Dynamic menu items will be inserted here -->
      </ul>
    </div>
  </nav>

  <!-- Checkout Section -->
  <section class="container mt-3">
    <h1 class="mb-2">Checkout</h1>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
      <!-- Checkout Form -->
      <div>
        <div class="card">
          <div class="card-body">
            <h2 class="mb-1">Shipping Information</h2>
            
            <form id="checkout-form">
              <div class="form-group">
                <label for="street">Street Address</label>
                <input type="text" id="street" class="form-control" required>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" class="form-control" required>
                </div>

                <div class="form-group">
                  <label for="state">State</label>
                  <input type="text" id="state" class="form-control" required>
                </div>
              </div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                  <label for="zipCode">Zip Code</label>
                  <input type="text" id="zipCode" class="form-control" required>
                </div>

                <div class="form-group">
                  <label for="country">Country</label>
                  <input type="text" id="country" class="form-control" required>
                </div>
              </div>

              <h2 class="mb-1 mt-2">Payment Method</h2>
              <div class="alert alert-warning">
                This is a dummy payment simulation. No real payment will be processed.
              </div>

              <div class="form-group">
                <label>
                  <input type="radio" name="payment" value="dummy" checked>
                  Dummy Payment (Simulation)
                </label>
              </div>

              <button type="submit" class="btn btn-primary btn-block">Place Order</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div>
        <div class="cart-summary">
          <h2 class="mb-1">Order Summary</h2>
          <div id="order-items" style="margin-bottom: 1rem; max-height: 300px; overflow-y: auto;">
            <!-- Order items will be loaded here -->
          </div>
          <div style="border-top: 1px solid #ddd; padding-top: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Subtotal:</span>
              <span id="subtotal">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <span>Tax (10%):</span>
              <span id="tax">$0.00</span>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: bold;">
            <span>Total:</span>
            <span id="total">$0.00</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="/assets/js/utils.js"></script>
  <script>
    if (!protectRoute()) {
      // Will redirect to login
    }

    let cart = null;

    // Load cart summary
    const loadCartSummary = async () => {
      try {
        const response = await apiRequest('/cart');
        cart = response.data;

        if (!cart || cart.items.length === 0) {
          showAlert('Your cart is empty', 'warning');
          setTimeout(() => {
            window.location.href = '/pages/products.html';
          }, 1500);
          return;
        }

        const container = document.getElementById('order-items');
        container.innerHTML = cart.items.map(item => `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid #eee;">
            <span>${item.product.name} x ${item.quantity}</span>
            <span>${formatCurrency(item.product.price * item.quantity)}</span>
          </div>
        `).join('');

        updateSummary();
      } catch (error) {
        showAlert('Failed to load cart', 'danger');
        console.error(error);
      }
    };

    // Update summary
    const updateSummary = () => {
      let subtotal = 0;

      if (cart && cart.items.length > 0) {
        subtotal = cart.items.reduce((total, item) => {
          return total + (item.product.price * item.quantity);
        }, 0);
      }

      const tax = subtotal * 0.1;
      const total = subtotal + tax;

      document.getElementById('subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('tax').textContent = formatCurrency(tax);
      document.getElementById('total').textContent = formatCurrency(total);
    };

    // Handle checkout
    document.getElementById('checkout-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const shippingAddress = {
        street: document.getElementById('street').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        zipCode: document.getElementById('zipCode').value,
        country: document.getElementById('country').value
      };

      try {
        // Create order
        const orderResponse = await apiRequest('/orders', {
          method: 'POST',
          body: JSON.stringify({
            items: cart.items.map(item => ({
              product: item.product._id,
              quantity: item.quantity
            })),
            shippingAddress
          })
        });

        // Simulate payment
        await apiRequest(`/orders/${orderResponse.data._id}/pay`, {
          method: 'PUT'
        });

        showAlert('Order placed successfully!', 'success');
        
        setTimeout(() => {
          window.location.href = '/pages/orders.html';
        }, 1500);
      } catch (error) {
        showAlert(error.message || 'Failed to place order', 'danger');
        console.error(error);
      }
    });

    // Load cart on page load
    loadCartSummary();
  </script>
</body>
</html>
