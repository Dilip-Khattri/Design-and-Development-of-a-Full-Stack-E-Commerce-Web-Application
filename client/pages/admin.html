<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - E-Shop</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href="/pages/index.html" class="navbar-brand">E-Shop Admin</a>
      <ul class="navbar-menu">
        <!-- Dynamic menu items will be inserted here -->
      </ul>
    </div>
  </nav>

  <!-- Admin Panel -->
  <section class="container mt-3">
    <h1 class="mb-2">Admin Dashboard</h1>

    <!-- Dashboard Stats -->
    <div class="dashboard-stats mb-3">
      <div class="stat-card">
        <h3>Total Users</h3>
        <div class="stat-value" id="total-users">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Products</h3>
        <div class="stat-value" id="total-products">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Orders</h3>
        <div class="stat-value" id="total-orders">0</div>
      </div>
      <div class="stat-card">
        <h3>Total Revenue</h3>
        <div class="stat-value" id="total-revenue">$0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-2">
      <button class="btn btn-primary" onclick="showTab('products')">Manage Products</button>
      <button class="btn btn-secondary" onclick="showTab('orders')">Manage Orders</button>
      <button class="btn btn-secondary" onclick="showTab('users')">View Users</button>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>Products Management</h2>
        <button class="btn btn-success" onclick="showAddProductModal()">Add New Product</button>
      </div>
      
      <div id="products-table-container">
        <!-- Products table will be loaded here -->
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-tab" class="tab-content hidden">
      <h2 class="mb-2">Orders Management</h2>
      <div id="orders-table-container">
        <!-- Orders table will be loaded here -->
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content hidden">
      <h2 class="mb-2">Users</h2>
      <div id="users-table-container">
        <!-- Users table will be loaded here -->
      </div>
    </div>
  </section>

  <!-- Add/Edit Product Modal -->
  <div id="product-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="product-modal-title">Add Product</h2>
        <span class="modal-close" onclick="closeProductModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="product-form">
          <input type="hidden" id="product-id">
          
          <div class="form-group">
            <label for="product-name">Name</label>
            <input type="text" id="product-name" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="product-description">Description</label>
            <textarea id="product-description" class="form-control" rows="3" required></textarea>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label for="product-price">Price</label>
              <input type="number" id="product-price" class="form-control" step="0.01" min="0" required>
            </div>

            <div class="form-group">
              <label for="product-stock">Stock</label>
              <input type="number" id="product-stock" class="form-control" min="0" required>
            </div>
          </div>

          <div class="form-group">
            <label for="product-category">Category</label>
            <input type="text" id="product-category" class="form-control" required>
          </div>

          <div class="form-group">
            <label for="product-image">Image URL</label>
            <input type="text" id="product-image" class="form-control" placeholder="/assets/images/product.jpg">
          </div>

          <button type="submit" class="btn btn-primary btn-block">Save Product</button>
        </form>
      </div>
    </div>
  </div>

  <script src="/assets/js/utils.js"></script>
  <script>
    if (!protectAdminRoute()) {
      // Will redirect to login
    }

    let currentTab = 'products';
    let editingProductId = null;

    // Load dashboard stats
    const loadStats = async () => {
      try {
        const response = await apiRequest('/admin/stats');
        const stats = response.data;

        document.getElementById('total-users').textContent = stats.totalUsers;
        document.getElementById('total-products').textContent = stats.totalProducts;
        document.getElementById('total-orders').textContent = stats.totalOrders;
        document.getElementById('total-revenue').textContent = formatCurrency(stats.totalRevenue);
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    };

    // Show tab
    const showTab = (tab) => {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      
      // Show selected tab
      document.getElementById(`${tab}-tab`).classList.remove('hidden');
      currentTab = tab;

      // Update button styles
      document.querySelectorAll('.container > div > button').forEach((btn, index) => {
        const tabs = ['products', 'orders', 'users'];
        if (tabs[index] === tab) {
          btn.className = 'btn btn-primary';
        } else {
          btn.className = 'btn btn-secondary';
        }
      });

      // Load tab data
      if (tab === 'products') loadProducts();
      else if (tab === 'orders') loadOrders();
      else if (tab === 'users') loadUsers();
    };

    // Load products
    const loadProducts = async () => {
      try {
        const container = document.getElementById('products-table-container');
        showLoading(container);

        const response = await apiRequest('/products');
        const products = response.data;

        if (products.length === 0) {
          container.innerHTML = '<p>No products found</p>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Category</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${products.map(product => `
                <tr>
                  <td>${product.name}</td>
                  <td>${formatCurrency(product.price)}</td>
                  <td>${product.stock}</td>
                  <td>${product.category}</td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="editProduct('${product._id}')">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product._id}')">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        showAlert('Failed to load products', 'danger');
      }
    };

    // Show add product modal
    const showAddProductModal = () => {
      editingProductId = null;
      document.getElementById('product-modal-title').textContent = 'Add Product';
      document.getElementById('product-form').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('product-modal').classList.add('show');
    };

    // Edit product
    const editProduct = async (productId) => {
      try {
        const response = await apiRequest(`/products/${productId}`);
        const product = response.data;

        editingProductId = productId;
        document.getElementById('product-modal-title').textContent = 'Edit Product';
        document.getElementById('product-id').value = productId;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-description').value = product.description;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-stock').value = product.stock;
        document.getElementById('product-category').value = product.category;
        document.getElementById('product-image').value = product.image;

        document.getElementById('product-modal').classList.add('show');
      } catch (error) {
        showAlert('Failed to load product', 'danger');
      }
    };

    // Delete product
    const deleteProduct = async (productId) => {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        await apiRequest(`/products/${productId}`, {
          method: 'DELETE'
        });

        showAlert('Product deleted successfully', 'success');
        loadProducts();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to delete product', 'danger');
      }
    };

    // Close product modal
    const closeProductModal = () => {
      document.getElementById('product-modal').classList.remove('show');
    };

    // Handle product form submit
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        price: parseFloat(document.getElementById('product-price').value),
        stock: parseInt(document.getElementById('product-stock').value),
        category: document.getElementById('product-category').value,
        image: document.getElementById('product-image').value || '/assets/images/default-product.jpg'
      };

      try {
        if (editingProductId) {
          // Update product
          await apiRequest(`/products/${editingProductId}`, {
            method: 'PUT',
            body: JSON.stringify(productData)
          });
          showAlert('Product updated successfully', 'success');
        } else {
          // Create product
          await apiRequest('/products', {
            method: 'POST',
            body: JSON.stringify(productData)
          });
          showAlert('Product created successfully', 'success');
        }

        closeProductModal();
        loadProducts();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to save product', 'danger');
      }
    });

    // Load orders
    const loadOrders = async () => {
      try {
        const container = document.getElementById('orders-table-container');
        showLoading(container);

        const response = await apiRequest('/orders');
        const orders = response.data;

        if (orders.length === 0) {
          container.innerHTML = '<p>No orders found</p>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Order ID</th>
                <th>User</th>
                <th>Date</th>
                <th>Total</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(order => `
                <tr>
                  <td>#${order._id.substring(0, 8)}</td>
                  <td>${order.user?.name || 'N/A'}</td>
                  <td>${formatDate(order.createdAt)}</td>
                  <td>${formatCurrency(order.totalAmount)}</td>
                  <td>
                    <select onchange="updateOrderStatus('${order._id}', this.value)" class="form-control">
                      <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                      <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Paid</option>
                      <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                      <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                      <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-primary" onclick="viewOrderDetails('${order._id}')">View</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        showAlert('Failed to load orders', 'danger');
      }
    };

    // Update order status
    const updateOrderStatus = async (orderId, status) => {
      try {
        await apiRequest(`/orders/${orderId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status })
        });

        showAlert('Order status updated', 'success');
        loadOrders();
        loadStats();
      } catch (error) {
        showAlert(error.message || 'Failed to update order status', 'danger');
        loadOrders();
      }
    };

    // View order details
    const viewOrderDetails = async (orderId) => {
      try {
        const response = await apiRequest(`/orders/${orderId}`);
        const order = response.data;

        alert(`Order Details:\n\nOrder ID: ${order._id}\nUser: ${order.user?.name}\nTotal: ${formatCurrency(order.totalAmount)}\nStatus: ${order.status}\nItems: ${order.items.length}\nAddress: ${order.shippingAddress.street}, ${order.shippingAddress.city}`);
      } catch (error) {
        showAlert('Failed to load order details', 'danger');
      }
    };

    // Load users
    const loadUsers = async () => {
      try {
        const container = document.getElementById('users-table-container');
        showLoading(container);

        const response = await apiRequest('/admin/users');
        const users = response.data;

        if (users.length === 0) {
          container.innerHTML = '<p>No users found</p>';
          return;
        }

        container.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Joined</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(user => `
                <tr>
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td><span class="btn btn-sm ${user.role === 'admin' ? 'btn-danger' : 'btn-secondary'}">${user.role}</span></td>
                  <td>${formatDate(user.createdAt)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (error) {
        showAlert('Failed to load users', 'danger');
      }
    };

    // Initialize
    loadStats();
    loadProducts();
  </script>
</body>
</html>
