/**
 * Admin Panel JavaScript
 * Handles admin-specific functionality
 */

// Delete confirmation
function confirmDelete(type, id, name) {
    return confirm(`Are you sure you want to delete this ${type}?\n\n${name}\n\nThis action cannot be undone.`);
}

// Update order status
function updateOrderStatus(orderId, status) {
    if (!confirm(`Update order status to "${status}"?`)) {
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = 'orders.php';
    
    const orderIdInput = document.createElement('input');
    orderIdInput.type = 'hidden';
    orderIdInput.name = 'order_id';
    orderIdInput.value = orderId;
    
    const statusInput = document.createElement('input');
    statusInput.type = 'hidden';
    statusInput.name = 'status';
    statusInput.value = status;
    
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'update_status';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = getCsrfToken();
    
    form.appendChild(orderIdInput);
    form.appendChild(statusInput);
    form.appendChild(actionInput);
    form.appendChild(csrfInput);
    
    document.body.appendChild(form);
    form.submit();
}

// Image preview for product form
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.getElementById('product-image');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const preview = document.getElementById('image-preview');
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// Auto-generate slug from product name
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('product-name');
    const slugInput = document.getElementById('product-slug');
    
    if (nameInput && slugInput) {
        nameInput.addEventListener('input', function() {
            // Only auto-generate if slug is empty or matches previous auto-generation
            const slug = generateSlug(this.value);
            if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
                slugInput.value = slug;
                slugInput.dataset.autoGenerated = 'true';
            }
        });
        
        slugInput.addEventListener('input', function() {
            // Mark as manually edited
            slugInput.dataset.autoGenerated = 'false';
        });
    }
});

// Generate slug from string
function generateSlug(str) {
    return str
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
}

// Get CSRF token
function getCsrfToken() {
    const tokenInput = document.querySelector('input[name="csrf_token"]');
    if (tokenInput) {
        return tokenInput.value;
    }
    return '';
}

// Form validation for product
function validateProductForm() {
    const name = document.getElementById('product-name');
    const slug = document.getElementById('product-slug');
    const price = document.getElementById('product-price');
    const stock = document.getElementById('product-stock');
    
    let isValid = true;
    let errors = [];
    
    if (!name || !name.value.trim()) {
        errors.push('Product name is required');
        isValid = false;
    }
    
    if (!slug || !slug.value.trim()) {
        errors.push('Product slug is required');
        isValid = false;
    }
    
    if (!price || !price.value || parseFloat(price.value) < 0) {
        errors.push('Valid price is required');
        isValid = false;
    }
    
    if (!stock || !stock.value || parseInt(stock.value) < 0) {
        errors.push('Valid stock quantity is required');
        isValid = false;
    }
    
    if (!isValid) {
        alert('Please fix the following errors:\n\n' + errors.join('\n'));
    }
    
    return isValid;
}

// Statistics counter animation
function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.textContent = Math.floor(progress * (end - start) + start);
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Animate dashboard statistics on load
document.addEventListener('DOMContentLoaded', function() {
    const statValues = document.querySelectorAll('.stat-value');
    statValues.forEach(element => {
        const value = parseInt(element.textContent.replace(/[^0-9]/g, ''));
        if (!isNaN(value)) {
            element.textContent = '0';
            setTimeout(() => {
                animateValue(element, 0, value, 1000);
            }, 100);
        }
    });
});

// Table search/filter
function filterTable(inputId, tableId) {
    const input = document.getElementById(inputId);
    const table = document.getElementById(tableId);
    
    if (!input || !table) return;
    
    const filter = input.value.toLowerCase();
    const rows = table.getElementsByTagName('tr');
    
    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent || cells[j].innerText;
            if (cellText.toLowerCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}

// Export table to CSV
function exportTableToCSV(tableId, filename) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let row of rows) {
        const cells = row.querySelectorAll('td, th');
        const rowData = Array.from(cells).map(cell => {
            return '"' + cell.textContent.replace(/"/g, '""') + '"';
        });
        csv.push(rowData.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('hidden', '');
    a.setAttribute('href', url);
    a.setAttribute('download', filename);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
